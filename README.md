# Vite web worker bundling issue

When running [PNext three loader](https://github.com/pnext/three-loader/tree/master) in a Vite bundled app there are issues with the web worker. Specifically the `adaptive` point type is not updated in the render loop, thus creating a `fixed` point type since the shader is not getting proper data.

## Steps

- `pnpm i` (install)
- `npm run dev` (start dev servers)

### Incorrect

- [localhost:3000](http://localhost:3000) (Vite app)

### Working

- [localhost:8080](http://localhost:8080) (Rollup app)
- [localhost:9000](http://localhost:9000) (Original PNext app with webpack)

To see issue, click `Load` on each page. What you will see is the pointcloud loading with `fixed` point type, when it should be `adaptive`. The way you can distinguish the two is:

- in `fixed` the points will start small and grow
- in `adaptive` the points will start big and shrink

This is simplified but should provide an adequate explanation of what to look for. By running the provided apps and comparing them, side-by-side, the difference will become clear (if their are any doubts).

As far as we can tell, the issue stems from how Vite deals with web workers when doing its "Vite magic".

## Possible Culprit

Looking closer at the final builds (i.e. this issue extends from `dev` to `prod` as well) we have come to the conclusion that their most be something with how Vite is handling the import of the web worker found in `apps/vite-app/src/pnext-loader/loading2/worker-pool.ts`.

In `createWorker` we've tried 2 ways of importing the web worker (both involve changing the `require` reference for proper Vite import handling):

1. `import DecoderWorker from './decoder.worker.js?worker&inline';` (**NOTE** Removing `inline` does not solve the issue. Using it helps us identify the difference in results between the Vite and Rollup bundlers)
2. `return new Worker(new URL('./decoder.worker.js', import.meta.url),{ type: 'module' });`

When comparing the base64 worker string from `?worker&inline` in Vite with the Rollup version, which appears to have a similar internal process, we found that the base64 string differs drastically.

Since Vite uses Rollup ("under the hood"), and using Rollup directly works, it seems reasonable to assume that the issue stems from how Vite deals with web workers.

Also worth mentioning is that we've logged the workers in console during runtime and can see that the working version (i.e. the Rollup version) has a ton more data, as expected (considering the huge difference between the 2 base64 strings).

Below are both worker base64 strings in the final build from their respective bundlers.

#### Vite base64 string

<details>
KGZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiOyhmdW5jdGlvbigpe2NvbnN0IHQ9e0RBVEFfVFlQRV9ET1VCTEU6e29yZGluYWw6MCxuYW1lOiJkb3VibGUiLHNpemU6OH0sREFUQV9UWVBFX0ZMT0FUOntvcmRpbmFsOjEsbmFtZToiZmxvYXQiLHNpemU6NH0sREFUQV9UWVBFX0lOVDg6e29yZGluYWw6MixuYW1lOiJpbnQ4IixzaXplOjF9LERBVEFfVFlQRV9VSU5UODp7b3JkaW5hbDozLG5hbWU6InVpbnQ4IixzaXplOjF9LERBVEFfVFlQRV9JTlQxNjp7b3JkaW5hbDo0LG5hbWU6ImludDE2IixzaXplOjJ9LERBVEFfVFlQRV9VSU5UMTY6e29yZGluYWw6NSxuYW1lOiJ1aW50MTYiLHNpemU6Mn0sREFUQV9UWVBFX0lOVDMyOntvcmRpbmFsOjYsbmFtZToiaW50MzIiLHNpemU6NH0sREFUQV9UWVBFX1VJTlQzMjp7b3JkaW5hbDo3LG5hbWU6InVpbnQzMiIsc2l6ZTo0fSxEQVRBX1RZUEVfSU5UNjQ6e29yZGluYWw6OCxuYW1lOiJpbnQ2NCIsc2l6ZTo4fSxEQVRBX1RZUEVfVUlOVDY0OntvcmRpbmFsOjksbmFtZToidWludDY0IixzaXplOjh9fTtsZXQgaD0wO2Zvcihjb25zdCB5IGluIHQpdFtoXT10W3ldLGgrKztjbGFzcyBhe2NvbnN0cnVjdG9yKFAsRCxiLHo9WzEvMCwtMS8wXSl7dGhpcy5uYW1lPVAsdGhpcy50eXBlPUQsdGhpcy5udW1FbGVtZW50cz1iLHRoaXMucmFuZ2U9eix0aGlzLmJ5dGVTaXplPXRoaXMubnVtRWxlbWVudHMqdGhpcy50eXBlLnNpemUsdGhpcy5kZXNjcmlwdGlvbj0iIn19bmV3IGEoIlBPU0lUSU9OX0NBUlRFU0lBTiIsdC5EQVRBX1RZUEVfRkxPQVQsMyksbmV3IGEoIkNPTE9SX1BBQ0tFRCIsdC5EQVRBX1RZUEVfSU5UOCw0KSxuZXcgYSgiQ09MT1JfUEFDS0VEIix0LkRBVEFfVFlQRV9JTlQ4LDQpLG5ldyBhKCJDT0xPUl9QQUNLRUQiLHQuREFUQV9UWVBFX0lOVDgsMyksbmV3IGEoIk5PUk1BTF9GTE9BVFMiLHQuREFUQV9UWVBFX0ZMT0FULDMpLG5ldyBhKCJJTlRFTlNJVFkiLHQuREFUQV9UWVBFX1VJTlQxNiwxKSxuZXcgYSgiQ0xBU1NJRklDQVRJT04iLHQuREFUQV9UWVBFX1VJTlQ4LDEpLG5ldyBhKCJOT1JNQUxfU1BIRVJFTUFQUEVEIix0LkRBVEFfVFlQRV9VSU5UOCwyKSxuZXcgYSgiTk9STUFMX09DVDE2Iix0LkRBVEFfVFlQRV9VSU5UOCwyKSxuZXcgYSgiTk9STUFMIix0LkRBVEFfVFlQRV9GTE9BVCwzKSxuZXcgYSgiUkVUVVJOX05VTUJFUiIsdC5EQVRBX1RZUEVfVUlOVDgsMSksbmV3IGEoIk5VTUJFUl9PRl9SRVRVUk5TIix0LkRBVEFfVFlQRV9VSU5UOCwxKSxuZXcgYSgiU09VUkNFX0lEIix0LkRBVEFfVFlQRV9VSU5UMTYsMSksbmV3IGEoIklORElDRVMiLHQuREFUQV9UWVBFX1VJTlQzMiwxKSxuZXcgYSgiU1BBQ0lORyIsdC5EQVRBX1RZUEVfRkxPQVQsMSksbmV3IGEoIkdQU19USU1FIix0LkRBVEFfVFlQRV9ET1VCTEUsMSksY29uc29sZS5sb2coImRlY29kZXIgd29ya2VyIGxvYWRlZCIpO2NvbnN0IEw9e2ludDg6SW50OEFycmF5LGludDE2OkludDE2QXJyYXksaW50MzI6SW50MzJBcnJheSxpbnQ2NDpGbG9hdDY0QXJyYXksdWludDg6VWludDhBcnJheSx1aW50MTY6VWludDE2QXJyYXksdWludDMyOlVpbnQzMkFycmF5LHVpbnQ2NDpGbG9hdDY0QXJyYXksZmxvYXQ6RmxvYXQzMkFycmF5LGRvdWJsZTpGbG9hdDY0QXJyYXl9O29ubWVzc2FnZT1mdW5jdGlvbih5KXtjb25zb2xlLmxvZygiZGVjb2RlciB3b3JrZXIgb25tZXNzYWdlIik7bGV0e2J1ZmZlcjpQLHBvaW50QXR0cmlidXRlczpELHNjYWxlOmIsbmFtZTp6LG1pbjpkLG1heDprLHNpemU6ZyxvZmZzZXQ6RixudW1Qb2ludHM6bH09eS5kYXRhLEE9bmV3IERhdGFWaWV3KFApLE49e30sdT0wLFU9MDtmb3IobGV0IGUgb2YgRC5hdHRyaWJ1dGVzKVUrPWUuYnl0ZVNpemU7bGV0IGY9MzIscD1uZXcgVWludDMyQXJyYXkoZioqMyksQj0oZSxzLHIpPT57bGV0IG49ZiplL2cueCxvPWYqcy9nLnksaT1mKnIvZy56LFQ9TWF0aC5taW4ocGFyc2VJbnQobiksZi0xKSxJPU1hdGgubWluKHBhcnNlSW50KG8pLGYtMSksXz1NYXRoLm1pbihwYXJzZUludChpKSxmLTEpO3JldHVybiBUK0kqZitfKmYqZn0sTT0wLEU9W051bWJlci5QT1NJVElWRV9JTkZJTklUWSxOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZXSxtPVtOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFksTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLE51bWJlci5ORUdBVElWRV9JTkZJTklUWV07Zm9yKGxldCBlIG9mIEQuYXR0cmlidXRlcyl7aWYoWyJQT1NJVElPTl9DQVJURVNJQU4iLCJwb3NpdGlvbiJdLmluY2x1ZGVzKGUubmFtZSkpe2xldCBzPW5ldyBBcnJheUJ1ZmZlcihsKjQqMykscj1uZXcgRmxvYXQzMkFycmF5KHMpO2ZvcihsZXQgbj0wO248bDtuKyspe2xldCBvPW4qVSxpPUEuZ2V0SW50MzIobyt1KzAsITApKmJbMF0rRlswXS1kLngsVD1BLmdldEludDMyKG8rdSs0LCEwKSpiWzFdK0ZbMV0tZC55LEk9QS5nZXRJbnQzMihvK3UrOCwhMCkqYlsyXStGWzJdLWQuejtFWzBdPU1hdGgubWluKEVbMF0saSksRVsxXT1NYXRoLm1pbihFWzFdLFQpLEVbMl09TWF0aC5taW4oRVsyXSxJKSxtWzBdPU1hdGgubWF4KG1bMF0saSksbVsxXT1NYXRoLm1heChtWzFdLFQpLG1bMl09TWF0aC5tYXgobVsyXSxJKTtsZXQgXz1CKGksVCxJKTtwW19dKys9PT0wJiZNKyssclszKm4rMF09aSxyWzMqbisxXT1ULHJbMypuKzJdPUl9TltlLm5hbWVdPXtidWZmZXI6cyxhdHRyaWJ1dGU6ZX19ZWxzZSBpZihbIlJHQkEiLCJyZ2JhIl0uaW5jbHVkZXMoZS5uYW1lKSl7bGV0IHM9bmV3IEFycmF5QnVmZmVyKGwqNCkscj1uZXcgVWludDhBcnJheShzKTtmb3IobGV0IG49MDtuPGw7bisrKXtsZXQgbz1uKlUsaT1BLmdldFVpbnQxNihvK3UrMCwhMCksVD1BLmdldFVpbnQxNihvK3UrMiwhMCksST1BLmdldFVpbnQxNihvK3UrNCwhMCk7cls0Km4rMF09aT4yNTU/aS8yNTY6aSxyWzQqbisxXT1UPjI1NT9ULzI1NjpULHJbNCpuKzJdPUk+MjU1P0kvMjU2Okl9TltlLm5hbWVdPXtidWZmZXI6cyxhdHRyaWJ1dGU6ZX19ZWxzZXtsZXQgcz1uZXcgQXJyYXlCdWZmZXIobCo0KSxyPW5ldyBGbG9hdDMyQXJyYXkocyksbj1MW2UudHlwZS5uYW1lXSxvPW5ldyBuKGwpLFtpLFRdPVswLDFdO2NvbnN0IEk9e2ludDg6QS5nZXRJbnQ4LGludDE2OkEuZ2V0SW50MTYsaW50MzI6QS5nZXRJbnQzMix1aW50ODpBLmdldFVpbnQ4LHVpbnQxNjpBLmdldFVpbnQxNix1aW50MzI6QS5nZXRVaW50MzIsZmxvYXQ6QS5nZXRGbG9hdDMyLGRvdWJsZTpBLmdldEZsb2F0NjR9W2UudHlwZS5uYW1lXS5iaW5kKEEpO2lmKGUudHlwZS5zaXplPjQpe2xldFtfLHddPWUucmFuZ2U7aT1fLFQ9MS8ody1fKX1mb3IobGV0IF89MDtfPGw7XysrKXtsZXQgdz1fKlUsWT1JKHcrdSwhMCk7cltfXT0oWS1pKSpULG9bX109WX1OW2UubmFtZV09e2J1ZmZlcjpzLHByZWNpc2VCdWZmZXI6byxhdHRyaWJ1dGU6ZSxvZmZzZXQ6aSxzY2FsZTpUfX11Kz1lLmJ5dGVTaXplfWxldCBDPXBhcnNlSW50KGwvTSk7e2xldCBlPW5ldyBBcnJheUJ1ZmZlcihsKjQpLHM9bmV3IFVpbnQzMkFycmF5KGUpO2ZvcihsZXQgcj0wO3I8bDtyKyspc1tyXT1yO04uSU5ESUNFUz17YnVmZmVyOmUsYXR0cmlidXRlOmEuSU5ESUNFU319e2xldCBlPUQudmVjdG9ycztmb3IobGV0IHMgb2YgZSl7bGV0e25hbWU6cixhdHRyaWJ1dGVzOm59PXMsbz1uLmxlbmd0aCxpPW5ldyBBcnJheUJ1ZmZlcihvKmwqNCksVD1uZXcgRmxvYXQzMkFycmF5KGkpLEk9MDtmb3IobGV0IHcgb2Ygbil7bGV0IFk9Tlt3XSx7b2Zmc2V0Ongsc2NhbGU6Vn09WSxSPW5ldyBEYXRhVmlldyhZLmJ1ZmZlcik7Y29uc3QgRz1SLmdldEZsb2F0MzIuYmluZChSKTtmb3IobGV0IE89MDtPPGw7TysrKXtsZXQgSz1HKE8qNCwhMCk7VFtPKm8rSV09Sy9WK3h9SSsrfWxldCBfPW5ldyBhKHIsdC5EQVRBX1RZUEVfRkxPQVQsMyk7TltyXT17YnVmZmVyOmksYXR0cmlidXRlOl99fX1sZXQgYz17YnVmZmVyOlAsYXR0cmlidXRlQnVmZmVyczpOLGRlbnNpdHk6Qyx0aWdodEJvdW5kaW5nQm94OnttaW46RSxtYXg6bX19LFM9W107Zm9yKGxldCBlIGluIGMuYXR0cmlidXRlQnVmZmVycylTLnB1c2goYy5hdHRyaWJ1dGVCdWZmZXJzW2VdLmJ1ZmZlcik7Uy5wdXNoKFApLHBvc3RNZXNzYWdlKGMsUyl9fSkoKX0pKCk7Cg==
</details>

#### Rollup base64 string

<details>
Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIC8qKgogICAgICogU29tZSB0eXBlcyBvZiBwb3NzaWJsZSBwb2ludCBhdHRyaWJ1dGUgZGF0YSBmb3JtYXRzCiAgICAgKgogICAgICogQGNsYXNzCiAgICAgKi8KICAgIGNvbnN0IFBvaW50QXR0cmlidXRlVHlwZXMgPSB7CiAgICAgICAgREFUQV9UWVBFX0RPVUJMRTogeyBvcmRpbmFsOiAwLCBuYW1lOiAnZG91YmxlJywgc2l6ZTogOCB9LAogICAgICAgIERBVEFfVFlQRV9GTE9BVDogeyBvcmRpbmFsOiAxLCBuYW1lOiAnZmxvYXQnLCBzaXplOiA0IH0sCiAgICAgICAgREFUQV9UWVBFX0lOVDg6IHsgb3JkaW5hbDogMiwgbmFtZTogJ2ludDgnLCBzaXplOiAxIH0sCiAgICAgICAgREFUQV9UWVBFX1VJTlQ4OiB7IG9yZGluYWw6IDMsIG5hbWU6ICd1aW50OCcsIHNpemU6IDEgfSwKICAgICAgICBEQVRBX1RZUEVfSU5UMTY6IHsgb3JkaW5hbDogNCwgbmFtZTogJ2ludDE2Jywgc2l6ZTogMiB9LAogICAgICAgIERBVEFfVFlQRV9VSU5UMTY6IHsgb3JkaW5hbDogNSwgbmFtZTogJ3VpbnQxNicsIHNpemU6IDIgfSwKICAgICAgICBEQVRBX1RZUEVfSU5UMzI6IHsgb3JkaW5hbDogNiwgbmFtZTogJ2ludDMyJywgc2l6ZTogNCB9LAogICAgICAgIERBVEFfVFlQRV9VSU5UMzI6IHsgb3JkaW5hbDogNywgbmFtZTogJ3VpbnQzMicsIHNpemU6IDQgfSwKICAgICAgICBEQVRBX1RZUEVfSU5UNjQ6IHsgb3JkaW5hbDogOCwgbmFtZTogJ2ludDY0Jywgc2l6ZTogOCB9LAogICAgICAgIERBVEFfVFlQRV9VSU5UNjQ6IHsgb3JkaW5hbDogOSwgbmFtZTogJ3VpbnQ2NCcsIHNpemU6IDggfQogICAgfTsKICAgIGxldCBpID0gMDsKICAgIGZvciAoY29uc3Qgb2JqIGluIFBvaW50QXR0cmlidXRlVHlwZXMpIHsKICAgICAgICBQb2ludEF0dHJpYnV0ZVR5cGVzW2ldID0gUG9pbnRBdHRyaWJ1dGVUeXBlc1tvYmpdOwogICAgICAgIGkrKzsKICAgIH0KICAgIGNsYXNzIFBvaW50QXR0cmlidXRlIHsKICAgICAgICBjb25zdHJ1Y3RvcihuYW1lLCB0eXBlLCBudW1FbGVtZW50cywgcmFuZ2UgPSBbSW5maW5pdHksIC1JbmZpbml0eV0pIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKICAgICAgICAgICAgdGhpcy5udW1FbGVtZW50cyA9IG51bUVsZW1lbnRzOwogICAgICAgICAgICB0aGlzLnJhbmdlID0gcmFuZ2U7CiAgICAgICAgICAgIHRoaXMuYnl0ZVNpemUgPSB0aGlzLm51bUVsZW1lbnRzICogdGhpcy50eXBlLnNpemU7CiAgICAgICAgICAgIHRoaXMuZGVzY3JpcHRpb24gPSAnJzsKICAgICAgICB9CiAgICB9CiAgICAoewogICAgICAgIFBPU0lUSU9OX0NBUlRFU0lBTjogbmV3IFBvaW50QXR0cmlidXRlKCdQT1NJVElPTl9DQVJURVNJQU4nLCBQb2ludEF0dHJpYnV0ZVR5cGVzLkRBVEFfVFlQRV9GTE9BVCwgMyksCiAgICAgICAgUkdCQV9QQUNLRUQ6IG5ldyBQb2ludEF0dHJpYnV0ZSgnQ09MT1JfUEFDS0VEJywgUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfSU5UOCwgNCksCiAgICAgICAgQ09MT1JfUEFDS0VEOiBuZXcgUG9pbnRBdHRyaWJ1dGUoJ0NPTE9SX1BBQ0tFRCcsIFBvaW50QXR0cmlidXRlVHlwZXMuREFUQV9UWVBFX0lOVDgsIDQpLAogICAgICAgIFJHQl9QQUNLRUQ6IG5ldyBQb2ludEF0dHJpYnV0ZSgnQ09MT1JfUEFDS0VEJywgUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfSU5UOCwgMyksCiAgICAgICAgTk9STUFMX0ZMT0FUUzogbmV3IFBvaW50QXR0cmlidXRlKCdOT1JNQUxfRkxPQVRTJywgUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfRkxPQVQsIDMpLAogICAgICAgIElOVEVOU0lUWTogbmV3IFBvaW50QXR0cmlidXRlKCdJTlRFTlNJVFknLCBQb2ludEF0dHJpYnV0ZVR5cGVzLkRBVEFfVFlQRV9VSU5UMTYsIDEpLAogICAgICAgIENMQVNTSUZJQ0FUSU9OOiBuZXcgUG9pbnRBdHRyaWJ1dGUoJ0NMQVNTSUZJQ0FUSU9OJywgUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfVUlOVDgsIDEpLAogICAgICAgIE5PUk1BTF9TUEhFUkVNQVBQRUQ6IG5ldyBQb2ludEF0dHJpYnV0ZSgnTk9STUFMX1NQSEVSRU1BUFBFRCcsIFBvaW50QXR0cmlidXRlVHlwZXMuREFUQV9UWVBFX1VJTlQ4LCAyKSwKICAgICAgICBOT1JNQUxfT0NUMTY6IG5ldyBQb2ludEF0dHJpYnV0ZSgnTk9STUFMX09DVDE2JywgUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfVUlOVDgsIDIpLAogICAgICAgIE5PUk1BTDogbmV3IFBvaW50QXR0cmlidXRlKCdOT1JNQUwnLCBQb2ludEF0dHJpYnV0ZVR5cGVzLkRBVEFfVFlQRV9GTE9BVCwgMyksCiAgICAgICAgUkVUVVJOX05VTUJFUjogbmV3IFBvaW50QXR0cmlidXRlKCdSRVRVUk5fTlVNQkVSJywgUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfVUlOVDgsIDEpLAogICAgICAgIE5VTUJFUl9PRl9SRVRVUk5TOiBuZXcgUG9pbnRBdHRyaWJ1dGUoJ05VTUJFUl9PRl9SRVRVUk5TJywgUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfVUlOVDgsIDEpLAogICAgICAgIFNPVVJDRV9JRDogbmV3IFBvaW50QXR0cmlidXRlKCdTT1VSQ0VfSUQnLCBQb2ludEF0dHJpYnV0ZVR5cGVzLkRBVEFfVFlQRV9VSU5UMTYsIDEpLAogICAgICAgIElORElDRVM6IG5ldyBQb2ludEF0dHJpYnV0ZSgnSU5ESUNFUycsIFBvaW50QXR0cmlidXRlVHlwZXMuREFUQV9UWVBFX1VJTlQzMiwgMSksCiAgICAgICAgU1BBQ0lORzogbmV3IFBvaW50QXR0cmlidXRlKCdTUEFDSU5HJywgUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfRkxPQVQsIDEpLAogICAgICAgIEdQU19USU1FOiBuZXcgUG9pbnRBdHRyaWJ1dGUoJ0dQU19USU1FJywgUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfRE9VQkxFLCAxKQogICAgfSk7CgogICAgY29uc29sZS5sb2coJ3RvcCBsZXZlbCwgc2hvdWxkIG9ubHkgcnVuIG9uY2UnKTsKICAgIGNvbnN0IHR5cGVkQXJyYXlNYXBwaW5nID0gewogICAgICAgICdpbnQ4JzogICBJbnQ4QXJyYXksCiAgICAgICAgJ2ludDE2JzogIEludDE2QXJyYXksCiAgICAgICAgJ2ludDMyJzogIEludDMyQXJyYXksCiAgICAgICAgJ2ludDY0JzogIEZsb2F0NjRBcnJheSwKICAgICAgICAndWludDgnOiAgVWludDhBcnJheSwKICAgICAgICAndWludDE2JzogVWludDE2QXJyYXksCiAgICAgICAgJ3VpbnQzMic6IFVpbnQzMkFycmF5LAogICAgICAgICd1aW50NjQnOiBGbG9hdDY0QXJyYXksCiAgICAgICAgJ2Zsb2F0JzogIEZsb2F0MzJBcnJheSwKICAgICAgICAnZG91YmxlJzogRmxvYXQ2NEFycmF5LAogICAgfTsKCiAgICBvbm1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgIGNvbnNvbGUubG9nKCdpbnNpZGUgb25tZXNzYWdlJyk7CiAgICAgICAgbGV0IHtidWZmZXIsIHBvaW50QXR0cmlidXRlcywgc2NhbGUsIG5hbWUsIG1pbiwgbWF4LCBzaXplLCBvZmZzZXQsIG51bVBvaW50c30gPSBldmVudC5kYXRhOwoKICAgICAgICBsZXQgdmlldyA9IG5ldyBEYXRhVmlldyhidWZmZXIpOwogICAgICAgIAogICAgICAgIGxldCBhdHRyaWJ1dGVCdWZmZXJzID0ge307CiAgICAgICAgbGV0IGF0dHJpYnV0ZU9mZnNldCA9IDA7CgogICAgICAgIGxldCBieXRlc1BlclBvaW50ID0gMDsKICAgICAgICBmb3IgKGxldCBwb2ludEF0dHJpYnV0ZSBvZiBwb2ludEF0dHJpYnV0ZXMuYXR0cmlidXRlcykgewogICAgICAgICAgICBieXRlc1BlclBvaW50ICs9IHBvaW50QXR0cmlidXRlLmJ5dGVTaXplOwogICAgICAgIH0KCiAgICAgICAgbGV0IGdyaWRTaXplID0gMzI7CiAgICAgICAgbGV0IGdyaWQgPSBuZXcgVWludDMyQXJyYXkoZ3JpZFNpemUgKiogMyk7CiAgICAgICAgbGV0IHRvSW5kZXggPSAoeCwgeSwgeikgPT4gewogICAgICAgICAgICAvLyBtaW4gaXMgYWxyZWFkeSBzdWJ0cmFjdGVkCiAgICAgICAgICAgIGxldCBkeCA9IGdyaWRTaXplICogeCAvIHNpemUueDsKICAgICAgICAgICAgbGV0IGR5ID0gZ3JpZFNpemUgKiB5IC8gc2l6ZS55OwogICAgICAgICAgICBsZXQgZHogPSBncmlkU2l6ZSAqIHogLyBzaXplLno7CgogICAgICAgICAgICBsZXQgaXggPSBNYXRoLm1pbihwYXJzZUludChkeCksIGdyaWRTaXplIC0gMSk7CiAgICAgICAgICAgIGxldCBpeSA9IE1hdGgubWluKHBhcnNlSW50KGR5KSwgZ3JpZFNpemUgLSAxKTsKICAgICAgICAgICAgbGV0IGl6ID0gTWF0aC5taW4ocGFyc2VJbnQoZHopLCBncmlkU2l6ZSAtIDEpOwoKICAgICAgICAgICAgbGV0IGluZGV4ID0gaXggKyBpeSAqIGdyaWRTaXplICsgaXogKiBncmlkU2l6ZSAqIGdyaWRTaXplOwoKICAgICAgICAgICAgcmV0dXJuIGluZGV4OwogICAgICAgIH07CgogICAgICAgIGxldCBudW1PY2N1cGllZENlbGxzID0gMDsKCiAgICAgICAgbGV0IHRpZ2h0Qm94TWluID0gW051bWJlci5QT1NJVElWRV9JTkZJTklUWSwgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLCBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFldOwogICAgICAgIGxldCB0aWdodEJveE1heCA9IFtOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFksIE51bWJlci5ORUdBVElWRV9JTkZJTklUWSwgTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZXTsKCiAgICAgICAgZm9yIChsZXQgcG9pbnRBdHRyaWJ1dGUgb2YgcG9pbnRBdHRyaWJ1dGVzLmF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKFsnUE9TSVRJT05fQ0FSVEVTSUFOJywgJ3Bvc2l0aW9uJ10uaW5jbHVkZXMocG9pbnRBdHRyaWJ1dGUubmFtZSkpewogICAgICAgICAgICAgICAgbGV0IGJ1ZmYgPSBuZXcgQXJyYXlCdWZmZXIobnVtUG9pbnRzICogNCAqIDMpOwogICAgICAgICAgICAgICAgbGV0IHBvc2l0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkoYnVmZik7CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBudW1Qb2ludHM7IGorKykgewogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxldCBwb2ludE9mZnNldCA9IGogKiBieXRlc1BlclBvaW50OwoKICAgICAgICAgICAgICAgICAgICBsZXQgeCA9ICh2aWV3LmdldEludDMyKHBvaW50T2Zmc2V0ICsgYXR0cmlidXRlT2Zmc2V0ICsgMCwgdHJ1ZSkgKiBzY2FsZVswXSkgKyBvZmZzZXRbMF0gLSBtaW4ueDsKICAgICAgICAgICAgICAgICAgICBsZXQgeSA9ICh2aWV3LmdldEludDMyKHBvaW50T2Zmc2V0ICsgYXR0cmlidXRlT2Zmc2V0ICsgNCwgdHJ1ZSkgKiBzY2FsZVsxXSkgKyBvZmZzZXRbMV0gLSBtaW4ueTsKICAgICAgICAgICAgICAgICAgICBsZXQgeiA9ICh2aWV3LmdldEludDMyKHBvaW50T2Zmc2V0ICsgYXR0cmlidXRlT2Zmc2V0ICsgOCwgdHJ1ZSkgKiBzY2FsZVsyXSkgKyBvZmZzZXRbMl0gLSBtaW4uejsKCiAgICAgICAgICAgICAgICAgICAgdGlnaHRCb3hNaW5bMF0gPSBNYXRoLm1pbih0aWdodEJveE1pblswXSwgeCk7CiAgICAgICAgICAgICAgICAgICAgdGlnaHRCb3hNaW5bMV0gPSBNYXRoLm1pbih0aWdodEJveE1pblsxXSwgeSk7CiAgICAgICAgICAgICAgICAgICAgdGlnaHRCb3hNaW5bMl0gPSBNYXRoLm1pbih0aWdodEJveE1pblsyXSwgeik7CgogICAgICAgICAgICAgICAgICAgIHRpZ2h0Qm94TWF4WzBdID0gTWF0aC5tYXgodGlnaHRCb3hNYXhbMF0sIHgpOwogICAgICAgICAgICAgICAgICAgIHRpZ2h0Qm94TWF4WzFdID0gTWF0aC5tYXgodGlnaHRCb3hNYXhbMV0sIHkpOwogICAgICAgICAgICAgICAgICAgIHRpZ2h0Qm94TWF4WzJdID0gTWF0aC5tYXgodGlnaHRCb3hNYXhbMl0sIHopOwoKICAgICAgICAgICAgICAgICAgICBsZXQgaW5kZXggPSB0b0luZGV4KHgsIHksIHopOwogICAgICAgICAgICAgICAgICAgIGxldCBjb3VudCA9IGdyaWRbaW5kZXhdKys7CiAgICAgICAgICAgICAgICAgICAgaWYoY291bnQgPT09IDApewogICAgICAgICAgICAgICAgICAgICAgICBudW1PY2N1cGllZENlbGxzKys7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbnNbMyAqIGogKyAwXSA9IHg7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25zWzMgKiBqICsgMV0gPSB5OwogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uc1szICogaiArIDJdID0gejsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVCdWZmZXJzW3BvaW50QXR0cmlidXRlLm5hbWVdID0geyBidWZmZXI6IGJ1ZmYsIGF0dHJpYnV0ZTogcG9pbnRBdHRyaWJ1dGUgfTsKICAgICAgICAgICAgfWVsc2UgaWYoWydSR0JBJywgJ3JnYmEnXS5pbmNsdWRlcyhwb2ludEF0dHJpYnV0ZS5uYW1lKSl7CiAgICAgICAgICAgICAgICBsZXQgYnVmZiA9IG5ldyBBcnJheUJ1ZmZlcihudW1Qb2ludHMgKiA0KTsKICAgICAgICAgICAgICAgIGxldCBjb2xvcnMgPSBuZXcgVWludDhBcnJheShidWZmKTsKCiAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IG51bVBvaW50czsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHBvaW50T2Zmc2V0ID0gaiAqIGJ5dGVzUGVyUG9pbnQ7CgogICAgICAgICAgICAgICAgICAgIGxldCByID0gdmlldy5nZXRVaW50MTYocG9pbnRPZmZzZXQgKyBhdHRyaWJ1dGVPZmZzZXQgKyAwLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBsZXQgZyA9IHZpZXcuZ2V0VWludDE2KHBvaW50T2Zmc2V0ICsgYXR0cmlidXRlT2Zmc2V0ICsgMiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgbGV0IGIgPSB2aWV3LmdldFVpbnQxNihwb2ludE9mZnNldCArIGF0dHJpYnV0ZU9mZnNldCArIDQsIHRydWUpOwoKICAgICAgICAgICAgICAgICAgICBjb2xvcnNbNCAqIGogKyAwXSA9IHIgPiAyNTUgPyByIC8gMjU2IDogcjsKICAgICAgICAgICAgICAgICAgICBjb2xvcnNbNCAqIGogKyAxXSA9IGcgPiAyNTUgPyBnIC8gMjU2IDogZzsKICAgICAgICAgICAgICAgICAgICBjb2xvcnNbNCAqIGogKyAyXSA9IGIgPiAyNTUgPyBiIC8gMjU2IDogYjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVCdWZmZXJzW3BvaW50QXR0cmlidXRlLm5hbWVdID0geyBidWZmZXI6IGJ1ZmYsIGF0dHJpYnV0ZTogcG9pbnRBdHRyaWJ1dGUgfTsKICAgICAgICAgICAgfWVsc2UgewogICAgICAgICAgICAgICAgbGV0IGJ1ZmYgPSBuZXcgQXJyYXlCdWZmZXIobnVtUG9pbnRzICogNCk7CiAgICAgICAgICAgICAgICBsZXQgZjMyID0gbmV3IEZsb2F0MzJBcnJheShidWZmKTsKCiAgICAgICAgICAgICAgICBsZXQgVHlwZWRBcnJheSA9IHR5cGVkQXJyYXlNYXBwaW5nW3BvaW50QXR0cmlidXRlLnR5cGUubmFtZV07CiAgICAgICAgICAgICAgICBsZXQgcHJlY2lzZUJ1ZmZlciA9IG5ldyBUeXBlZEFycmF5KG51bVBvaW50cyk7CgogICAgICAgICAgICAgICAgbGV0IFtvZmZzZXQsIHNjYWxlXSA9IFswLCAxXTsKCiAgICAgICAgICAgICAgICBjb25zdCBnZXR0ZXJNYXAgPSB7CiAgICAgICAgICAgICAgICAgICAgJ2ludDgnOiAgIHZpZXcuZ2V0SW50OCwKICAgICAgICAgICAgICAgICAgICAnaW50MTYnOiAgdmlldy5nZXRJbnQxNiwKICAgICAgICAgICAgICAgICAgICAnaW50MzInOiAgdmlldy5nZXRJbnQzMiwKICAgICAgICAgICAgICAgICAgICAvLyAnaW50NjQnOiAgdmlldy5nZXRJbnQ2NCwKICAgICAgICAgICAgICAgICAgICAndWludDgnOiAgdmlldy5nZXRVaW50OCwKICAgICAgICAgICAgICAgICAgICAndWludDE2Jzogdmlldy5nZXRVaW50MTYsCiAgICAgICAgICAgICAgICAgICAgJ3VpbnQzMic6IHZpZXcuZ2V0VWludDMyLAogICAgICAgICAgICAgICAgICAgIC8vICd1aW50NjQnOiB2aWV3LmdldFVpbnQ2NCwKICAgICAgICAgICAgICAgICAgICAnZmxvYXQnOiAgdmlldy5nZXRGbG9hdDMyLAogICAgICAgICAgICAgICAgICAgICdkb3VibGUnOiB2aWV3LmdldEZsb2F0NjQsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgY29uc3QgZ2V0dGVyID0gZ2V0dGVyTWFwW3BvaW50QXR0cmlidXRlLnR5cGUubmFtZV0uYmluZCh2aWV3KTsKCiAgICAgICAgICAgICAgICAvLyBjb21wdXRlIG9mZnNldCBhbmQgc2NhbGUgdG8gcGFjayBsYXJnZXIgdHlwZXMgaW50byAzMiBiaXQgZmxvYXRzCiAgICAgICAgICAgICAgICBpZihwb2ludEF0dHJpYnV0ZS50eXBlLnNpemUgPiA0KXsKICAgICAgICAgICAgICAgICAgICBsZXQgW2FtaW4sIGFtYXhdID0gcG9pbnRBdHRyaWJ1dGUucmFuZ2U7CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ID0gYW1pbjsKICAgICAgICAgICAgICAgICAgICBzY2FsZSA9IDEgLyAoYW1heCAtIGFtaW4pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZvcihsZXQgaiA9IDA7IGogPCBudW1Qb2ludHM7IGorKyl7CiAgICAgICAgICAgICAgICAgICAgbGV0IHBvaW50T2Zmc2V0ID0gaiAqIGJ5dGVzUGVyUG9pbnQ7CiAgICAgICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gZ2V0dGVyKHBvaW50T2Zmc2V0ICsgYXR0cmlidXRlT2Zmc2V0LCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgZjMyW2pdID0gKHZhbHVlIC0gb2Zmc2V0KSAqIHNjYWxlOwogICAgICAgICAgICAgICAgICAgIHByZWNpc2VCdWZmZXJbal0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVCdWZmZXJzW3BvaW50QXR0cmlidXRlLm5hbWVdID0geyAKICAgICAgICAgICAgICAgICAgICBidWZmZXI6IGJ1ZmYsCiAgICAgICAgICAgICAgICAgICAgcHJlY2lzZUJ1ZmZlcjogcHJlY2lzZUJ1ZmZlciwKICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGU6IHBvaW50QXR0cmlidXRlLAogICAgICAgICAgICAgICAgICAgIG9mZnNldDogb2Zmc2V0LAogICAgICAgICAgICAgICAgICAgIHNjYWxlOiBzY2FsZSwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGF0dHJpYnV0ZU9mZnNldCArPSBwb2ludEF0dHJpYnV0ZS5ieXRlU2l6ZTsKCgogICAgICAgIH0KCiAgICAgICAgbGV0IG9jY3VwYW5jeSA9IHBhcnNlSW50KG51bVBvaW50cyAvIG51bU9jY3VwaWVkQ2VsbHMpOwoKICAgICAgICB7IC8vIGFkZCBpbmRpY2VzCiAgICAgICAgICAgIGxldCBidWZmID0gbmV3IEFycmF5QnVmZmVyKG51bVBvaW50cyAqIDQpOwogICAgICAgICAgICBsZXQgaW5kaWNlcyA9IG5ldyBVaW50MzJBcnJheShidWZmKTsKCiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgICAgICAgICAgIGluZGljZXNbaV0gPSBpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBhdHRyaWJ1dGVCdWZmZXJzWydJTkRJQ0VTJ10gPSB7IGJ1ZmZlcjogYnVmZiwgYXR0cmlidXRlOiBQb2ludEF0dHJpYnV0ZS5JTkRJQ0VTIH07CiAgICAgICAgfQoKCiAgICAgICAgeyAvLyBoYW5kbGUgYXR0cmlidXRlIHZlY3RvcnMKICAgICAgICAgICAgbGV0IHZlY3RvcnMgPSBwb2ludEF0dHJpYnV0ZXMudmVjdG9yczsKCiAgICAgICAgICAgIGZvcihsZXQgdmVjdG9yIG9mIHZlY3RvcnMpewoKICAgICAgICAgICAgICAgIGxldCB7bmFtZSwgYXR0cmlidXRlc30gPSB2ZWN0b3I7CiAgICAgICAgICAgICAgICBsZXQgbnVtVmVjdG9yRWxlbWVudHMgPSBhdHRyaWJ1dGVzLmxlbmd0aDsKICAgICAgICAgICAgICAgIGxldCBidWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIobnVtVmVjdG9yRWxlbWVudHMgKiBudW1Qb2ludHMgKiA0KTsKICAgICAgICAgICAgICAgIGxldCBmMzIgPSBuZXcgRmxvYXQzMkFycmF5KGJ1ZmZlcik7CgogICAgICAgICAgICAgICAgbGV0IGlFbGVtZW50ID0gMDsKICAgICAgICAgICAgICAgIGZvcihsZXQgc291cmNlTmFtZSBvZiBhdHRyaWJ1dGVzKXsKICAgICAgICAgICAgICAgICAgICBsZXQgc291cmNlQnVmZmVyID0gYXR0cmlidXRlQnVmZmVyc1tzb3VyY2VOYW1lXTsKICAgICAgICAgICAgICAgICAgICBsZXQge29mZnNldCwgc2NhbGV9ID0gc291cmNlQnVmZmVyOwogICAgICAgICAgICAgICAgICAgIGxldCB2aWV3ID0gbmV3IERhdGFWaWV3KHNvdXJjZUJ1ZmZlci5idWZmZXIpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBnZXR0ZXIgPSB2aWV3LmdldEZsb2F0MzIuYmluZCh2aWV3KTsKCiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBqID0gMDsgaiA8IG51bVBvaW50czsgaisrKXsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gZ2V0dGVyKGogKiA0LCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGYzMltqICogbnVtVmVjdG9yRWxlbWVudHMgKyBpRWxlbWVudF0gPSAodmFsdWUgLyBzY2FsZSkgKyBvZmZzZXQ7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpRWxlbWVudCsrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGxldCB2ZWNBdHRyaWJ1dGUgPSBuZXcgUG9pbnRBdHRyaWJ1dGUobmFtZSwgUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfRkxPQVQsIDMpOwoKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZUJ1ZmZlcnNbbmFtZV0gPSB7IAogICAgICAgICAgICAgICAgICAgIGJ1ZmZlcjogYnVmZmVyLCAKICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGU6IHZlY0F0dHJpYnV0ZSwKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICB9CgogICAgICAgIH0KCiAgICAgICAgbGV0IG1lc3NhZ2UgPSB7CiAgICAgICAgICAgIGJ1ZmZlcjogYnVmZmVyLAogICAgICAgICAgICBhdHRyaWJ1dGVCdWZmZXJzOiBhdHRyaWJ1dGVCdWZmZXJzLAogICAgICAgICAgICBkZW5zaXR5OiBvY2N1cGFuY3ksCiAgICAgICAgICAgIHRpZ2h0Qm91bmRpbmdCb3g6IHsgbWluOiB0aWdodEJveE1pbiwgbWF4OiB0aWdodEJveE1heCB9LAogICAgICAgIH07CgogICAgICAgIGxldCB0cmFuc2ZlcmFibGVzID0gW107CiAgICAgICAgZm9yIChsZXQgcHJvcGVydHkgaW4gbWVzc2FnZS5hdHRyaWJ1dGVCdWZmZXJzKSB7CiAgICAgICAgICAgIHRyYW5zZmVyYWJsZXMucHVzaChtZXNzYWdlLmF0dHJpYnV0ZUJ1ZmZlcnNbcHJvcGVydHldLmJ1ZmZlcik7CiAgICAgICAgfQogICAgICAgIHRyYW5zZmVyYWJsZXMucHVzaChidWZmZXIpOwoKICAgICAgICBwb3N0TWVzc2FnZShtZXNzYWdlLCB0cmFuc2ZlcmFibGVzKTsKICAgIH07Cgp9KSgpOwoK
</details>